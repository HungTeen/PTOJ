version: "3"
services:
  ptoj-redis:
    image: redis:7.2
    container_name: ptoj-redis
    restart: unless-stopped
    volumes:
      - ${PTOJ_DATA_DIRECTORY}/data/redis/data:/data
    networks:
      ptoj-network:
        ipv4_address: ${REDIS_HOST:-172.21.0.2}
    ports:
      - ${REDIS_PORT:-6379}:6379
    # --requirepass 后面为redis访问密码
    command: redis-server --requirepass ${REDIS_PASSWORD:-123456} --appendonly yes

  ptoj-mysql:
    build: src/mysql
    container_name: ptoj-mysql
    restart: unless-stopped
    volumes:
      - ${PTOJ_DIRECTORY}/data/mysql/data:/var/lib/mysql
    environment:
      - TZ=Asia/Shanghai
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:-123456} # mysql数据库root账号的密码
      - NACOS_USERNAME=${NACOS_USERNAME:-root} # 后续nacos所用管理员账号
      - NACOS_PASSWORD=${NACOS_PASSWORD:-123456} # 后续nacos所用管理员密码
    ports:
      - ${MYSQL_PUBLIC_PORT:-3306}:3306
    networks:
      ptoj-network:
        ipv4_address: ${MYSQL_HOST:-172.21.0.3}

  ptoj-nacos:
    image: nacos/nacos-server:v2.3.0-slim
    container_name: ptoj-nacos
    restart: unless-stopped
    depends_on:
      - ptoj-mysql
    environment:
      - JVM_XMX=384m
      - JVM_XMS=384m
      - JVM_XMN=192m
      - MODE=standalone
      - SPRING_DATASOURCE_PLATFORM=mysql
      - MYSQL_SERVICE_HOST=${MYSQL_HOST:-172.21.0.3}
      - MYSQL_SERVICE_PORT=3306
      - MYSQL_SERVICE_USER=root
      - MYSQL_SERVICE_PASSWORD=${MYSQL_ROOT_PASSWORD:-123456} # 与上面数据库密码一致
      - MYSQL_SERVICE_DB_NAME=nacos
      - NACOS_AUTH_ENABLE=true # 开启鉴权
      - NACOS_AUTH_IDENTITY_KEY=nacos
      - NACOS_AUTH_IDENTITY_VALUE=nacos
      - NACOS_AUTH_TOKEN=PangTeen012345678901234567890123456789012345678901234567890123456789
    ports:
      - ${NACOS_PORT:-8848}:8848
      - "9848:9848"
      - "9849:9849"
    #    healthcheck:
    #      test: curl -f http://${NACOS_HOST:-172.21.0.4}:8848/nacos/index.html || exit 1
    #      interval: 6s
    #      timeout: 10s
    #      retries: 10
    networks:
      ptoj-network:
        ipv4_address: ${NACOS_HOST:-172.21.0.4}

    #  ptoj-mq:
    #    image: rabbitmq:3.12.12-management
    #    container_name: ptoj-mq
    #    hostname: ptoj-mq
    #    restart: unless-stopped
    #    volumes:
    ##      - ${PTOJ_DIRECTORY}/data/rabbitmq/plugins:/plugins
    #      - ${PTOJ_DIRECTORY}/data/rabbitmq/data:/var/lib/rabbitmq
    #    environment:
    #      - RABBITMQ_DEFAULT_USER=root
    #      - RABBITMQ_DEFAULT_PASS=123456
    #    ports:
    #      - "15672:15672"
    #      - "5672:5672"
    #    networks:
    #      ptoj-network:
    #        ipv4_address: ${MQ_HOST:-172.21.0.5}

  ptoj-rocketmq-namesrv:
    image: apache/rocketmq:5.2.0
    container_name: ptoj-rocketmq-namesrv
    command: sh mqnamesrv
    restart: unless-stopped
    #    network_mode: host
    volumes:
      - ${PTOJ_DIRECTORY}/data/rocketmq/namesrv/logs:/home/rocketmq/logs/rocketmqlogs
    environment:
      JAVA_OPT: -server -Xms512m -Xmx512m
    ports:
      - "9876:9876"
    networks:
      ptoj-network:
        ipv4_address: ${ROCKET_MQ_SERVER_HOST:-172.21.0.10}

  ptoj-rocketmq-broker:
    image: apache/rocketmq:5.2.0
    container_name: ptoj-rocketmq-broker
    command: sh mqbroker -c /home/rocketmq/rocketmq-5.2.0/conf/broker.conf
    restart: unless-stopped
    #    network_mode: host
    depends_on:
      - ptoj-rocketmq-namesrv
    volumes:
      - ${PTOJ_DIRECTORY}/data/rocketmq/broker/conf/broker.conf:/home/rocketmq/rocketmq-5.2.0/conf/broker.conf
      - ${PTOJ_DIRECTORY}/data/rocketmq/broker/logs:/home/rocketmq/logs/rocketmqlogs
      - ${PTOJ_DIRECTORY}/data/rocketmq/broker/store:/home/rocketmq/store
    environment:
      NAMESRV_ADDR: ptoj-rocketmq-namesrv:9876
      JAVA_OPT_EXT: -server -Xms512M -Xmx512M -Xmn256m
    ports:
      - "10911:10911"
      - "10909:10909"
      - "10912:10912"
    networks:
      ptoj-network:
        ipv4_address: ${ROCKET_MQ_BROKER_HOST:-172.21.0.11}

  ptoj-mqconsole:
    image: apacherocketmq/rocketmq-dashboard:latest
    container_name: ptoj-mqconsole
    restart: unless-stopped
    #    network_mode: host
    depends_on:
      - ptoj-rocketmq-namesrv
    environment:
      JAVA_OPTS: -Dserver.port=19876 -Drocketmq.namesrv.addr=ptoj-rocketmq-namesrv:9876 -Dcom.rocketmq.sendMessageWithVIPChannel=false
    ports:
      - "19876:19876"
    networks:
      ptoj-network:
        ipv4_address: ${ROCKET_MQ_CONSOLE:-172.21.0.12}

  ptoj-judge:
    #    image: criyle/go-judge
    build: src/judge
    privileged: true
    volumes:
      - ${PTOJ_DIRECTORY}/data/judge/testcase:/judge/test_case
      - ${PTOJ_DIRECTORY}/data/judge/log:/judge/log
      - ${PTOJ_DIRECTORY}/data/judge/run:/judge/run
      - ${PTOJ_DIRECTORY}/data/judge/spj:/judge/spj
    environment:
      - shm-size=256m
    ports:
      - "5050:5050"
    networks:
      ptoj-network:
        ipv4_address: ${JUDGE_HOST:-172.21.0.6}

#  ptoj-es:
#    image: elasticsearch:7.14.0
#    container_name: ptoj-es
#    restart: unless-stopped
#    volumes:
#      - ${PTOJ_DIRECTORY}/data/elasticsearch/data:/usr/share/elasticsearch/data
#      - ${PTOJ_DIRECTORY}/data/elasticsearch/plugins:/usr/share/elasticsearch/plugins
#    environment:
#      - cluster.name=elasticsearch
#      - discovery.type=single-node
#      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
#    ports:
#      - "9200:9200"
#      - "9300:9300"
#    networks:
#      ptoj-network:
#        ipv4_address: ${ES:-172.21.0.6}

networks:
  ptoj-network:
    driver: bridge
    ipam:
      config:
        - subnet: ${SUBNET:-172.21.0.0/16}
          gateway: 172.21.0.1